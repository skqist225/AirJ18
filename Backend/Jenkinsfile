pipeline {
    agent any 
    options {
        skipStagesAfterUnstable()
    }
    stages {
        stage('Build') {
            steps {
                sh 'echo $(pwd)'
                sh 'mvn clean package --file */pom.xml'
            }
            // post {
                // success {
                    // echo 'Now archiving the artifacts...'
                    // archiveArtifacts artifacts: '**/target/*.war'
                // }
            // }
        }
        stage('Send Build Artifact To AWS S3') {
            environment {
                AWS_S3_BUCKET = 'airj18'
                BACKEND_FOLDER = 'Backend'
            }
            steps {
                sh 'aws s3 cp ${WORKSPACE}/${BACKEND_FOLDER}/target/*.war s3://${AWS_S3_BUCKET}'
            }
        }
        stage('Deploy Application Prodution Stage') {
            environment { 
                DB_URL = credentials('DB_URL')
                DB_USER = credentials('DB_USER')
                DB_PASS = credentials('DB_PASS')
            }
            steps {
                timeout(time:5, unit:'DAYS') {
                    input message: 'Approve PRODUCTION Deployment?'
                }
                sshPublisher(
                    publishers: [sshPublisherDesc(configName: 'ubuntu@54.255.237.181', 
                    transfers: [sshTransfer(cleanRemote: false, excludes: '', 
                    execCommand: '~/airtnt-build.sh ${DB_URL} ${DB_USER} ${DB_PASS}', 
                    execTimeout: 120000, flatten: false, makeEmptyDirs: false, noDefaultExcludes: false, 
                    patternSeparator: '[, ]+', remoteDirectory: '', remoteDirectorySDF: false, removePrefix: '', sourceFiles: '.')], 
                    usePromotionTimestamp: false, useWorkspaceInPromotion: false, verbose: false)]
                )
            }
            post {
                success {
                    emailext body: 'build successfully.', recipientProviders: [buildUser()], subject: 'Build AirJ18 Successfully', to: 'thuan.leminhthuan.10.2@gmail.com'
                }
            }
        }
    }
}

